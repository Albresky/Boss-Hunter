<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOSS直聘职位数据查看器</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Tabulator.js 样式和脚本 -->
    <link href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator_midnight.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>
    <!-- 引入 PapaParse 用于前端解析CSV文件 -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <!-- 引入 Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* 自定义样式 */
        body { font-family: 'Inter', sans-serif; background-color: #1a202c; color: #e2e8f0; }
        .tabulator { border-radius: 8px; border: 1px solid #4a5568; }
        .tabulator .tabulator-header { background-color: #2d3748; border-bottom: 1px solid #4a5568; }
        /*.tabulator .tabulator-row { background-color: #2d3748; }*/
        .tabulator .tabulator-row:hover { background-color: #4a5568; }
        .tabulator-col-title { text-align: center; }
        /*.tabulator .tabulator-cell { border-right: 1px solid #4a5568; white-space: pre-wrap; }*/

        /* 为表格行增加底部边框，即行线 */
        .tabulator .tabulator-row {
            background-color: #2d3748;
            border-bottom: 1px solid #4a5568; /* 新增行线 */
        }
        /* 减少单元格的垂直内边距 (padding) */
        .tabulator .tabulator-cell {
            border-right: 1px solid #4a5568;
            white-space: pre-wrap;
            padding-top: 8px;    /* 减少上内边距 */
            padding-bottom: 8px; /* 减少下内边距 */
        }
        /* 自定义加载动画 */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Toggle Switch Styles */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #48bb78;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #48bb78;
        }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div class="mx-auto">
        <header class="flex items-center justify-between mb-6">
            <h1 class="text-2xl sm:text-3xl font-bold text-white flex items-center">
                <i data-lucide="briefcase" class="mr-3"></i>
                BOSS直聘职位数据查看器
            </h1>
        </header>

        <div class="bg-gray-800 p-4 rounded-lg shadow-lg mb-6 flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4" style="align-items: center;">
            <div class="w-full sm:w-auto flex-grow">
                <label for="file-select" class="block text-sm font-medium text-gray-300 mb-1">从服务器加载</label>
                <div class="flex">
                    <select id="file-select" class="block w-full bg-gray-700 border border-gray-600 text-white rounded-l-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        </select>
                    <button id="load-server-file" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-r-md inline-flex items-center">
                        <i data-lucide="download-cloud" class="mr-2 h-4 w-4"></i>
                        <span>加载</span>
                    </button>
                </div>
            </div>

            <div class="flex items-center pt-5 sm:pt-0">
                 <label for="auto-refresh-toggle" class="text-sm font-medium text-gray-300 mr-2">自动刷新</label>
                 <div class="relative inline-block w-10 align-middle select-none transition duration-200 ease-in">
                     <input type="checkbox" name="auto-refresh-toggle" id="auto-refresh-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                     <label for="auto-refresh-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-600 cursor-pointer"></label>
                 </div>
            </div>

            <div class="text-gray-400">或</div>

            <div class="w-full sm:w-auto">
                <label for="file-upload" class="block text-sm font-medium text-gray-300 mb-1" style="text-align: center;">从本地上传</label>
                <label class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md inline-flex items-center cursor-pointer">
                    <i data-lucide="upload-cloud" class="mr-2 h-4 w-4"></i>
                    <span>选择文件...</span>
                    <input id="file-upload" type="file" class="hidden" accept=".csv,.json">
                </label>
            </div>
        </div>

        <div id="loading-indicator" class="hidden loader"></div>
        <div id="job-table" class="bg-gray-800 rounded-lg shadow-lg"></div>
    </div>

    <script>
        // 激活 Lucide 图标
        lucide.createIcons();

        // --- DOM 元素获取 ---
        const fileSelect = document.getElementById('file-select');
        const loadServerFileBtn = document.getElementById('load-server-file');
        const fileUploadInput = document.getElementById('file-upload');
        const loadingIndicator = document.getElementById('loading-indicator');
        const tableContainer = document.getElementById('job-table');
        const autoRefreshToggle = document.getElementById('auto-refresh-toggle');

        // --- Auto-Refresh Logic ---
        let autoRefreshIntervalId = null;
        const REFRESH_INTERVAL = 10000; // 10 seconds

        // --- Tabulator 表格初始化 ---
        // 自定义格式化函数，用于解析Excel的HYPERLINK公式
        const hyperlinkFormatter = function(cell, formatterParams, onRendered){
            const cellValue = cell.getValue();
            if (cellValue && cellValue.toLowerCase().startsWith('=hyperlink(')) {
                // 正则表达式提取URL和链接文本
                const match = cellValue.match(/=hyperlink\("([^"]+)"\s*,\s*"([^"]+)"\)/i);
                if (match && match.length === 3) {
                    const url = match[1];
                    const text = match[2].replace(/""/g, '"');
                    return `<a href="${url}" target="_blank" class="text-indigo-400 hover:text-indigo-300 hover:underline">${text}</a>`;
                }
            }
            return cellValue;
        };

        const table = new Tabulator("#job-table", {
            height: "70vh",
            layout: "fitData",
            movableColumns: true,
            placeholder: "<div class='text-gray-400 p-4'>请先从上方选择一个文件加载数据</div>",
            columns: [
                {title:"编号", formatter:"rownum", hozAlign:"center", width:70, frozen:true, vertAlign:"middle"},
                {title: "获取时间", field: "获取时间", sorter: "string", hozAlign: "center", vertAlign: "middle"},
                {title: "职位名称", field: "职位名称", sorter: "string", headerFilter: "input", hozAlign: "center", vertAlign: "middle"},
                {title: "薪资", field: "薪资", sorter: "string", width: 150, hozAlign: "center", vertAlign: "middle"},
                {title: "公司", field: "公司", sorter: "string", headerFilter: "input", hozAlign: "center", vertAlign: "middle"},
                {title: "地点", field: "base地点", sorter: "string", hozAlign: "center", vertAlign: "middle"},
                {title: "经验", field: "工作经验", sorter: "string", hozAlign: "center", vertAlign: "middle"},
                {title: "学历", field: "学历", sorter: "string", hozAlign: "center", vertAlign: "middle"},
                {title: "福利待遇", field: "福利待遇", sorter: "string", width: 100, formatter: "textarea",  hozAlign: "center", vertAlign: "middle"},
                {title: "领域Tag", field: "领域tag", sorter: "string", width: 200, formatter: "textarea", hozAlign: "center", vertAlign: "middle"},
                {title: "职位描述", field: "职位描述内容", sorter: "string", formatter: "textarea", minWidth: 300, maxWidth:550, vertAlign: "middle"},
                {title: "JD链接", field: "JD链接", sorter: "string", formatter: hyperlinkFormatter, hozAlign: "center", width: 200, vertAlign: "middle"},
            ],
        });

        // --- 功能函数 ---
        function showLoading() {
            loadingIndicator.classList.remove('hidden');
            tableContainer.classList.add('hidden');
        }

        function hideLoading() {
            loadingIndicator.classList.add('hidden');
            tableContainer.classList.remove('hidden');
        }
        
        async function loadServerFiles() {
            try {
                const response = await fetch('/api/files');
                const files = await response.json();
                const currentFile = fileSelect.value;
                
                // Clear existing options except for the placeholder
                fileSelect.innerHTML = '<option>请选择一个文件...</option>';
                
                files.forEach(file => {
                    const option = document.createElement('option');
                    option.value = file;
                    option.textContent = file;
                    fileSelect.appendChild(option);
                });

                // Restore previous selection if it still exists
                if (Array.from(fileSelect.options).some(opt => opt.value === currentFile)) {
                    fileSelect.value = currentFile;
                }

            } catch (error) {
                console.error('加载服务器文件列表失败:', error);
                // Don't alert here to avoid spamming the user
            }
        }
        
        // Modified to accept a 'silent' flag to suppress alerts during auto-refresh
        async function loadDataFromServer(filename, silent = false) {
            if (!filename || filename === '请选择一个文件...') {
                if (!silent) alert('请先选择一个文件！');
                return;
            }
            if(!silent) showLoading();
            try {
                const response = await fetch(`/api/data/${filename}`);
                if (!response.ok) {
                    throw new Error(`服务器错误: ${response.statusText}`);
                }
                const data = await response.json();
                
                if(!silent) hideLoading();
                await table.setData(data);

            } catch (error) {
                console.error('加载数据失败:', error);
                if (!silent) alert(`加载文件 ${filename} 失败！`);
                if(!silent) hideLoading();
            }
        }
        
        function loadDataFromLocal(file) {
            showLoading();
            const reader = new FileReader();
            
            const processData = (data) => {
                hideLoading();
                table.setData(data);
            };

            if (file.name.endsWith('.json')) {
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        processData(data);
                    } catch (e) {
                        alert('解析JSON文件失败，请确保文件格式正确！');
                        hideLoading();
                    }
                };
                reader.readAsText(file);
            } else if (file.name.endsWith('.csv')) {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        processData(results.data);
                    },
                    error: (err) => {
                        alert('解析CSV文件失败！');
                        console.error(err);
                        hideLoading();
                    }
                });
            } else {
                alert('不支持的文件格式，请选择 .csv 或 .json 文件。');
                hideLoading();
            }
        }

        function stopAutoRefresh() {
            if (autoRefreshIntervalId) {
                clearInterval(autoRefreshIntervalId);
                autoRefreshIntervalId = null;
                autoRefreshToggle.checked = false;
            }
        }

        // --- 事件绑定 ---
        document.addEventListener('DOMContentLoaded', () => {
             loadServerFiles();
             // Periodically check for new files, but less frequently.
             setInterval(loadServerFiles, 30000); 
        });

        loadServerFileBtn.addEventListener('click', () => {
            stopAutoRefresh();
            loadDataFromServer(fileSelect.value);
        });

        fileSelect.addEventListener('change', () => {
            stopAutoRefresh();
        });

        fileUploadInput.addEventListener('change', (event) => {
            stopAutoRefresh();
            const file = event.target.files[0];
            if (file) {
                loadDataFromLocal(file);
            }
        });

        autoRefreshToggle.addEventListener('change', (event) => {
            if (event.target.checked) {
                const selectedFile = fileSelect.value;
                if (selectedFile && selectedFile !== '请选择一个文件...') {
                    // Immediately load data, then set the interval
                    loadDataFromServer(selectedFile, true); 
                    autoRefreshIntervalId = setInterval(() => {
                        // Pass true for the 'silent' parameter to avoid alerts
                        loadDataFromServer(fileSelect.value, true); 
                    }, REFRESH_INTERVAL);
                } else {
                    alert('请先选择一个文件再开启自动刷新。');
                    event.target.checked = false; // Reset the toggle if no file is selected
                }
            } else {
                stopAutoRefresh();
            }
        });

    </script>
</body>
</html>