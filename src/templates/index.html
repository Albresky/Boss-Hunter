<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOSS直聘职位数据查看器</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Tabulator.js 样式和脚本 -->
    <link href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator_midnight.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>
    <!-- 引入 PapaParse 用于前端解析CSV文件 -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <!-- 引入 Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* 自定义样式 */
        body { font-family: 'Inter', sans-serif; background-color: #1a202c; color: #e2e8f0; }
        .tabulator { border-radius: 8px; border: 1px solid #4a5568; }
        .tabulator .tabulator-header { background-color: #2d3748; border-bottom: 1px solid #4a5568; }
        /*.tabulator .tabulator-row { background-color: #2d3748; }*/
        .tabulator .tabulator-row:hover { background-color: #4a5568; }
        .tabulator-col-title { text-align: center; }
        /*.tabulator .tabulator-cell { border-right: 1px solid #4a5568; white-space: pre-wrap; }*/

        /* 为表格行增加底部边框，即行线 */
        .tabulator .tabulator-row { 
            background-color: #2d3748;
            border-bottom: 1px solid #4a5568; /* 新增行线 */
        }
        /* 减少单元格的垂直内边距 (padding) */
        .tabulator .tabulator-cell { 
            border-right: 1px solid #4a5568; 
            white-space: pre-wrap;
            padding-top: 8px;    /* 减少上内边距 */
            padding-bottom: 8px; /* 减少下内边距 */
        }
        /* 自定义加载动画 */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div class="mx-auto">
        <header class="flex items-center justify-between mb-6">
            <h1 class="text-2xl sm:text-3xl font-bold text-white flex items-center">
                <i data-lucide="briefcase" class="mr-3"></i>
                BOSS直聘职位数据查看器
            </h1>
        </header>

        <div class="bg-gray-800 p-4 rounded-lg shadow-lg mb-6 flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4">
            <!-- 从服务器加载 -->
            <div class="w-full sm:w-auto flex-grow">
                <label for="file-select" class="block text-sm font-medium text-gray-300 mb-1">从服务器加载</label>
                <div class="flex">
                    <select id="file-select" class="block w-full bg-gray-700 border border-gray-600 text-white rounded-l-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <option>请选择一个文件...</option>
                    </select>
                    <button id="load-server-file" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-r-md inline-flex items-center">
                        <i data-lucide="download-cloud" class="mr-2 h-4 w-4"></i>
                        <span>加载</span>
                    </button>
                </div>
            </div>
            
            <div class="text-gray-400">或</div>

            <!-- 从本地上传 -->
            <div class="w-full sm:w-auto">
                <label for="file-upload" class="block text-sm font-medium text-gray-300 mb-1">从本地上传</label>
                <label class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md inline-flex items-center cursor-pointer">
                    <i data-lucide="upload-cloud" class="mr-2 h-4 w-4"></i>
                    <span>选择文件...</span>
                    <input id="file-upload" type="file" class="hidden" accept=".csv,.json">
                </label>
            </div>
        </div>
        
        <div id="loading-indicator" class="hidden loader"></div>
        <div id="job-table" class="bg-gray-800 rounded-lg shadow-lg"></div>
    </div>

    <script>
        // 激活 Lucide 图标
        lucide.createIcons();

        // --- DOM 元素获取 ---
        const fileSelect = document.getElementById('file-select');
        const loadServerFileBtn = document.getElementById('load-server-file');
        const fileUploadInput = document.getElementById('file-upload');
        const loadingIndicator = document.getElementById('loading-indicator');
        const tableContainer = document.getElementById('job-table');

        // --- Tabulator 表格初始化 ---
        // 自定义格式化函数，用于解析Excel的HYPERLINK公式
        const hyperlinkFormatter = function(cell, formatterParams, onRendered){
            const cellValue = cell.getValue();
            if (cellValue && cellValue.toLowerCase().startsWith('=hyperlink(')) {
                // 正则表达式提取URL和链接文本
                const match = cellValue.match(/=hyperlink\("([^"]+)"\s*,\s*"([^"]+)"\)/i);
                if (match && match.length === 3) {
                    const url = match[1];
                    const text = match[2].replace(/""/g, '"'); // 将Excel的 "" 转义变回 "
                    return `<a href="${url}" target="_blank" class="text-indigo-400 hover:text-indigo-300 hover:underline">${text}</a>`;
                }
            }
            return cellValue; // 如果不是公式，直接返回值
        };

        const table = new Tabulator("#job-table", {
            height: "70vh", // 表格高度
            layout: "fitData", // 列宽自适应
            movableColumns: true, // 允许拖拽列
            placeholder: "<div class='text-gray-400 p-4'>请先从上方选择一个文件加载数据</div>",
            columns: [
                {title:"编号", formatter:"rownum", hozAlign:"center", width:70, frozen:true, hozAlign:"center", vertAlign:"middle"},
                {title: "获取时间", field: "获取时间", sorter: "string", hozAlign: "center", vertAlign: "middle"},
                {title: "职位名称", field: "职位名称", sorter: "string", headerFilter: "input", hozAlign: "center", vertAlign: "middle"},
                {title: "薪资", field: "薪资", sorter: "string", width: 150, hozAlign: "center", vertAlign: "middle"},
                {title: "公司", field: "公司", sorter: "string", headerFilter: "input", hozAlign: "center", vertAlign: "middle"},
                {title: "地点", field: "base地点", sorter: "string", hozAlign: "center", vertAlign: "middle"},
                {title: "经验", field: "工作经验", sorter: "string", hozAlign: "center", vertAlign: "middle"},
                {title: "学历", field: "学历", sorter: "string", hozAlign: "center", vertAlign: "middle"},
                {title: "福利待遇", field: "福利待遇", sorter: "string", width: 100, formatter: "textarea",  hozAlign: "center", vertAlign: "middle"},
                {title: "领域Tag", field: "领域tag", sorter: "string", width: 200, formatter: "textarea", hozAlign: "center", vertAlign: "middle"},
                {title: "职位描述", field: "职位描述内容", sorter: "string", formatter: "textarea", minWidth: 300, maxWidth:550, vertAlign: "middle"},
                {title: "JD链接", field: "JD链接", sorter: "string", formatter: hyperlinkFormatter, hozAlign: "center", width: 200,  hozAlign: "center", vertAlign: "middle"},
            ],
        });

        // --- 功能函数 ---
        function showLoading() {
            loadingIndicator.classList.remove('hidden');
            tableContainer.classList.add('hidden');
        }

        function hideLoading() {
            loadingIndicator.classList.add('hidden');
            tableContainer.classList.remove('hidden');
        }

              // 从服务器加载选定的文件数据
        async function loadDataFromServer(filename) {
            if (!filename || filename === '请选择一个文件...') {
                alert('请先选择一个文件！');
                return;
            }
            showLoading();
            try {
                const response = await fetch(`/api/data/${filename}`);
                if (!response.ok) {
                    throw new Error(`服务器错误: ${response.statusText}`);
                }
                const data = await response.json();
                
                // 【关键修正】先显示表格容器，再填充数据
                hideLoading(); 
                await table.setData(data);

            } catch (error) {
                console.error('加载数据失败:', error);
                alert(`加载文件 ${filename} 失败！`);
                hideLoading(); // 如果出错，也要确保隐藏加载动画
            }
        }
        async function loadServerFiles() {
            try {
                const response = await fetch('/api/files');
                const files = await response.json();
                fileSelect.innerHTML = '<option>请选择一个文件...</option>'; // 重置
                files.forEach(file => {
                    const option = document.createElement('option');
                    option.value = file;
                    option.textContent = file;
                    fileSelect.appendChild(option);
                });
            } catch (error) {
                console.error('加载服务器文件列表失败:', error);
                alert('无法加载服务器文件列表，请检查后台服务是否运行。');
            }
        }

        // 从服务器加载选定的文件数据
        async function loadDataFromServer(filename) {
            if (!filename || filename === '请选择一个文件...') {
                alert('请先选择一个文件！');
                return;
            }
            showLoading();
            try {
                const response = await fetch(`/api/data/${filename}`);
                if (!response.ok) {
                    throw new Error(`服务器错误: ${response.statusText}`);
                }
                const data = await response.json();
                
                // 【关键修正】先显示表格容器，再填充数据
                hideLoading(); 
                await table.setData(data);

            } catch (error) {
                console.error('加载数据失败:', error);
                alert(`加载文件 ${filename} 失败！`);
                hideLoading(); // 如果出错，也要确保隐藏加载动画
            }
        }

        // 从本地加载文件数据
        function loadDataFromLocal(file) {
            showLoading();
            const reader = new FileReader();
            
            const processData = (data) => {
                hideLoading(); // 关键：先显示表格容器
                table.setData(data); // 再填充数据
            };

            if (file.name.endsWith('.json')) {
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        processData(data);
                    } catch (e) {
                        alert('解析JSON文件失败，请确保文件格式正确！');
                        hideLoading();
                    }
                };
                reader.readAsText(file);
            } else if (file.name.endsWith('.csv')) {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        processData(results.data);
                    },
                    error: (err) => {
                        alert('解析CSV文件失败！');
                        console.error(err);
                        hideLoading();
                    }
                });
            } else {
                alert('不支持的文件格式，请选择 .csv 或 .json 文件。');
                hideLoading();
            }
        }

        // --- 事件绑定 ---
        document.addEventListener('DOMContentLoaded', loadServerFiles);
        loadServerFileBtn.addEventListener('click', () => {
            loadDataFromServer(fileSelect.value);
        });
        fileUploadInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                loadDataFromLocal(file);
            }
        });

    </script>
</body>
</html>